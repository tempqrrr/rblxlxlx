-- Local Config Variables
local bossAutoFarm = false
local bossInstakill = false
local frontDistance = 9
local downwardDistance = 120
local bossTweenSpeed = 0.6
local downTweenSpeed = 0.6
local retreatTime = 2

-- Cooldown flags
local canTweenToBoss = true
local canRetreat = true

-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local workspace = game:GetService("Workspace")

-- Helper to tween player
local function tweenToPosition(position, speed)
    local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if root and root.Parent then
        local tween = TweenService:Create(root, TweenInfo.new(speed, Enum.EasingStyle.Linear), {CFrame = CFrame.new(position)})
        tween:Play()
    end
end

-- Get Boss HRP
local function getBossHRP()
    local entitiesFolder = workspace:FindFirstChild("Entities")
    if not entitiesFolder then return nil end
    for _, entity in ipairs(entitiesFolder:GetChildren()) do
        if not Players:GetPlayerFromCharacter(entity) then
            local hrp = entity:FindFirstChild("HumanoidRootPart")
            if hrp then return hrp end
        end
    end
    return nil
end

-- Retreat underground
local function retreatDown()
    if not canRetreat then return end
    canRetreat = false
    local character = player.Character
    if character then
        local hrp = character:FindFirstChild("HumanoidRootPart")
        if hrp then
            local downPos = Vector3.new(hrp.Position.X, hrp.Position.Y - downwardDistance, hrp.Position.Z)
            tweenToPosition(downPos, downTweenSpeed)
        end
    end
    task.delay(3, function() canRetreat = true end)
end

-- Try to move to boss
local function moveToBoss()
    if not canTweenToBoss then return end
    canTweenToBoss = false
    local bossHRP = getBossHRP()
    if bossHRP then
        local targetPosition = bossHRP.Position + (bossHRP.CFrame.LookVector * frontDistance)
        tweenToPosition(targetPosition, bossTweenSpeed)
    end
    task.delay(2, function() canTweenToBoss = true end)
end

-- Boss Instakill
local function tryStartInstakill()
    if not (bossAutoFarm and bossInstakill) then return end

    local entitiesFolder = workspace:FindFirstChild("Entities")
    if not entitiesFolder then
        warn("Entities folder not found")
        return
    end

    task.spawn(function()
        while bossAutoFarm and bossInstakill do
            for _, entity in ipairs(entitiesFolder:GetChildren()) do
                if not Players:GetPlayerFromCharacter(entity) then
                    local bossHumanoid = entity:FindFirstChildOfClass("Humanoid")
                    if bossHumanoid and bossHumanoid.Health < 2000 then
                        bossHumanoid.Health = -1
                        print("bos Instakilled")
                        return
                    end
                end
            end
            task.wait(0.5)
        end
    end)
end

-- Helper scripts executor
local function waitForBossAndRunHelpers()
    task.spawn(function()
        print("Waiting for boss...")
        local entitiesFolder = workspace:FindFirstChild("Entities")
        if not entitiesFolder then
            warn("Entities folder not found")
            return
        end
        while #entitiesFolder:GetChildren() < 2 do
            task.wait(0.1)
        end
        print("boss spawned!")

        coroutine.wrap(function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/tempqrrr/rblxlxlx/refs/heads/main/weapon"))()
        end)()
        coroutine.wrap(function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/tempqrrr/rblxlxlx/refs/heads/main/m1"))()
        end)()
        coroutine.wrap(function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/tempqrrr/rblxlxlx/refs/heads/main/facer"))()
        end)()
        coroutine.wrap(function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/tempqrrr/rblxlxlx/refs/heads/main/roller"))()
        end)()
    end)
end

-- Per-respawn autofarm logic
local function handleRespawn(character)
    print("respawn detected")
    tryStartInstakill()

    local startTime = os.clock()
    local duration = 55 - retreatTime

    task.spawn(function()
        while bossAutoFarm and player.Character == character do
            local elapsed = os.clock() - startTime
            if elapsed < duration then
                moveToBoss()
            else
                retreatDown()
            end
            task.wait(0.1)
        end
    end)
end

-- AutoFarm toggle logic
local respawnConnection
local function BOSSAUTOFARM(toggleState)
    bossAutoFarm = toggleState

    if not bossAutoFarm then
        print("[DEBUG] Boss Auto-Farm DISABLED")
        if respawnConnection then
            respawnConnection:Disconnect()
            respawnConnection = nil
        end
        return
    end

    print("[DEBUG] Boss Auto-Farm ENABLED")

    waitForBossAndRunHelpers()

    -- Connect to respawn detection immediately
    respawnConnection = player.CharacterAdded:Connect(handleRespawn)

    -- Also trigger for current character
    if player.Character then
        handleRespawn(player.Character)
    end
end

-- GUI Setup
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
   Name = "Fatman fanclub",
   LoadingTitle = "Exps for a shitty ass game",
   LoadingSubtitle = "by wad",
   Theme = "Amethyst",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = "waadghoulre",
      FileName = "wadadadad"
   }
})

local BossTab = Window:CreateTab("Boss Autofarm", nil)
BossTab:CreateSection("Boss Toggle")

BossTab:CreateToggle({
   Name = "Boss Autofarm",
   CurrentValue = false,
   Flag = "Toggle1",
   Callback = function(Value)
       BOSSAUTOFARM(Value)
   end,
})

BossTab:CreateToggle({
   Name = "Boss Instakill",
   CurrentValue = false,
   Flag = "Toggle2",
   Callback = function(Value)
       bossInstakill = Value
       if bossAutoFarm and bossInstakill then
           tryStartInstakill()
       end
   end,
})

-- Sliders
BossTab:CreateDivider()
BossTab:CreateSection("Distance settings")

BossTab:CreateSlider({
   Name = "Boss Distance",
   Range = {0, 30},
   Increment = 1,
   Suffix = "Studs",
   CurrentValue = frontDistance,
   Flag = "Slider1",
   Callback = function(Value)
       frontDistance = Value
   end,
})

BossTab:CreateSlider({
   Name = "Down Distance",
   Range = {0, 200},
   Increment = 5,
   Suffix = "Studs",
   CurrentValue = downwardDistance,
   Flag = "Slider2",
   Callback = function(Value)
       downwardDistance = Value
   end,
})

BossTab:CreateDivider()
BossTab:CreateSection("Speed settings")

BossTab:CreateSlider({
   Name = "Boss TP Speed",
   Range = {0, 2},
   Increment = 0.1,
   Suffix = "Seconds",
   CurrentValue = bossTweenSpeed,
   Flag = "Slider3",
   Callback = function(Value)
       bossTweenSpeed = Value
   end,
})

BossTab:CreateSlider({
   Name = "Down TP Speed",
   Range = {0, 2},
   Increment = 0.1,
   Suffix = "Seconds",
   CurrentValue = downTweenSpeed,
   Flag = "Slider4",
   Callback = function(Value)
       downTweenSpeed = Value
   end,
})

BossTab:CreateSlider({
   Name = "Retreat Time",
   Range = {0, 55},
   Increment = 1,
   Suffix = "Seconds",
   CurrentValue = retreatTime,
   Flag = "Slider5",
   Callback = function(Value)
       retreatTime = Value
   end,
})

BossTab:CreateDivider()
